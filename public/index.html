<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YouTube Subscriber Widget</title>
  <style>
    :root{
      --bg: #fff;
      --card: rgba(255,255,255,0.85);
      --border: rgba(0,0,0,0.10);
      --text: rgba(0,0,0,0.88);
      --muted: rgba(0,0,0,0.55);
      --accent: #ffb3c7; /* 디어디오 파스텔 느낌 기본 */
      --barbg: rgba(0,0,0,0.08);
      --barfg: rgba(0,0,0,0.55);
    }
    body{ margin:0; font-family: system-ui, -apple-system, "Apple SD Gothic Neo", "Noto Sans KR", sans-serif; background: var(--bg); color: var(--text); }
    .wrap{ width:100%; max-width: 520px; padding: 12px; box-sizing:border-box; }
    .card{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      background: var(--card);
      backdrop-filter: blur(6px);
    }
    .row{ display:flex; justify-content: space-between; align-items: baseline; gap: 12px; }
    .label{ font-size: 14px; color: var(--muted); margin-bottom: 6px; }
    .big{ font-size: 22px; font-weight: 800; }
    .small{ font-size: 14px; color: var(--muted); }
    .bar{ margin-top: 10px; height: 10px; border-radius: 999px; background: var(--barbg); overflow:hidden; }
    .bar > div{ height:100%; width:0%; background: var(--barfg); border-radius: 999px; transition: width .4s ease; }
    .err{ margin-top: 10px; font-size: 12px; color: #d00; }

    /* 설정 UI */
    .config{ margin-top: 12px; border:1px dashed var(--border); border-radius: 14px; padding: 12px; }
    .config h3{ margin:0 0 10px 0; font-size: 14px; }
    .grid{ display:grid; grid-template-columns: 1fr; gap: 8px; }
    .grid label{ font-size: 12px; color: var(--muted); }
    input{ width:100%; padding: 10px; border-radius: 12px; border:1px solid var(--border); font-size: 14px; box-sizing:border-box; }
    button{ padding: 10px 12px; border-radius: 12px; border:1px solid var(--border); background:#fff; cursor:pointer; font-size: 14px; }
    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top: 8px; }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 8px; line-height: 1.35; }

    /* embed=1이면 설정 UI 숨김 */
    body.embed .config{ display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="label" id="label">구독자 달성률</div>
      <div class="row">
        <div class="big" id="subs">불러오는 중…</div>
        <div class="small" id="goal">목표 -</div>
      </div>
      <div class="bar"><div id="bar"></div></div>
      <div class="err" id="err" style="display:none;"></div>
    </div>

    <div class="config" id="config">
      <h3>설정(PC에서만 사용 추천)</h3>
      <div class="grid">
        <div>
          <label>채널(핸들 또는 채널ID)</label>
          <input id="inChannel" placeholder="@TodayDio 또는 UCxxxx" value="@TodayDio" />
        </div>
        <div>
          <label>목표 구독자</label>
          <input id="inGoal" placeholder="1000" value="1000" />
        </div>
        <div>
          <label>라벨</label>
          <input id="inLabel" placeholder="구독자 달성률" value="구독자 달성률" />
        </div>
        <div>
          <label>갱신 주기(초) - 서버 캐시</label>
          <input id="inRefresh" placeholder="21600" value="21600" />
        </div>
      </div>
      <div class="btnrow">
        <button id="btnOpen">임베드 링크 열기</button>
        <button id="btnCopy">임베드 링크 복사</button>
      </div>
      <div class="hint">
        노션에는 반드시 <b>embed=1</b>이 포함된 링크를 넣어야 모바일에서 “설정창처럼” 안 보이고, 위젯만 깔끔하게 보여요.
      </div>
    </div>
  </div>

<script>
  const qs = new URLSearchParams(location.search);

  // embed 모드
  const isEmbed = qs.get("embed") === "1";
  if (isEmbed) document.body.classList.add("embed");

  // 파라미터
  const channel = qs.get("channel") || "@TodayDio";
  const goal = Number(qs.get("goal") || "1000");
  const label = qs.get("label") || "구독자 달성률";
  const refresh = qs.get("refresh") || "21600";

  // 표시
  const $label = document.getElementById("label");
  const $subs = document.getElementById("subs");
  const $goal = document.getElementById("goal");
  const $bar = document.getElementById("bar");
  const $err = document.getElementById("err");

  $label.textContent = label;
  $goal.textContent = `목표 ${goal.toLocaleString("ko-KR")} (${0.0}%)`;

  function showError(msg){
    $err.style.display = "block";
    $err.textContent = msg;
  }

  async function load(){
    try{
      const url = `/api/youtube?channel=${encodeURIComponent(channel)}&refresh=${encodeURIComponent(refresh)}`;
      const res = await fetch(url);
      const data = await res.json();

      if(!data.ok){
        showError(data.error || "불러오기 실패");
        $subs.textContent = "—";
        return;
      }
      const sub = Number(data.subscriberCount || 0);
      const ratio = goal > 0 ? Math.max(0, Math.min(100, (sub / goal) * 100)) : 0;

      $subs.textContent = `${sub.toLocaleString("ko-KR")}명`;
      $goal.textContent = `목표 ${goal.toLocaleString("ko-KR")} (${ratio.toFixed(1)}%)`;
      $bar.style.width = `${ratio}%`;
    }catch(e){
      showError(e.message || "오류");
      $subs.textContent = "—";
    }
  }
  load();

  // 설정 UI 동작 (embed=1에서는 숨겨짐)
  const inChannel = document.getElementById("inChannel");
  const inGoal = document.getElementById("inGoal");
  const inLabel = document.getElementById("inLabel");
  const inRefresh = document.getElementById("inRefresh");

  function makeEmbedUrl(){
    const u = new URL(location.origin + location.pathname);
    u.searchParams.set("embed", "1");
    u.searchParams.set("channel", inChannel.value.trim() || "@TodayDio");
    u.searchParams.set("goal", String(Number(inGoal.value || "1000")));
    u.searchParams.set("label", inLabel.value.trim() || "구독자 달성률");
    u.searchParams.set("refresh", String(Number(inRefresh.value || "21600")));
    return u.toString();
  }

  document.getElementById("btnOpen").onclick = () => window.open(makeEmbedUrl(), "_blank");
  document.getElementById("btnCopy").onclick = async () => {
    const u = makeEmbedUrl();
    try{
      await navigator.clipboard.writeText(u);
      alert("복사 완료!");
    }catch{
      prompt("복사해서 쓰세요:", u);
    }
  };
</script>
</body>
</html>
