<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="referrer" content="origin" />
  <title>YouTube Subscribers Widget</title>
  <style>
    :root { --size: 220px; --stroke: 16; }
    body { margin:0; min-height:100vh; display:grid; place-items:center; font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans KR",sans-serif; background:transparent; padding:20px; }
    .card { width:min(420px,92vw); padding:18px; border-radius:18px; background:rgba(255,255,255,.78); backdrop-filter:blur(10px); box-shadow:0 10px 30px rgba(0,0,0,.08); }
    .title { font-size:14px; opacity:.75; margin-bottom:10px; }
    .cfg { display:grid; gap:10px; }
    label { font-size:12px; opacity:.8; }
    input { width:100%; box-sizing:border-box; padding:10px 12px; border-radius:12px; border:1px solid rgba(0,0,0,.12); background:rgba(255,255,255,.9); font-size:14px; }
    button { padding:10px 12px; border-radius:12px; border:none; cursor:pointer; background:rgba(0,0,0,.85); color:#fff; font-size:14px; }
    .ghost { background:rgba(0,0,0,.06); color:rgba(0,0,0,.85); }
    .small { font-size:12px; opacity:.75; line-height:1.45; }
    .mono { font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono"; font-size:12px; }
    .hr { height:1px; background:rgba(0,0,0,.08); margin:12px 0; }

    .wrap { display:grid; place-items:center; }
    .ring { width:var(--size); height:var(--size); position:relative; }
    .center { position:absolute; inset:0; display:grid; place-items:center; text-align:center; }
    .count { font-size:30px; font-weight:700; line-height:1.05; }
    .sub { font-size:13px; opacity:.7; margin-top:6px; }
    .pct { font-size:13px; opacity:.85; margin-top:10px; }
    .err { font-size:12px; color:#b00020; margin-top:10px; white-space:pre-wrap; }

    /* âœ… ì•ˆì „ì¥ì¹˜: ê¸°ë³¸ì€ ì„¤ì • í™”ë©´ì´ ë³´ì´ê²Œ */
    #config { display:block; }
    #widget { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <div class="title" id="title">YouTube êµ¬ë…ì</div>

    <div id="config">
      <div class="cfg">
        <div>
          <label>1) YouTube API Key (ë³¸ì¸ ê²ƒ)</label>
          <input id="apiKeyInput" placeholder="AIza... ë¡œ ì‹œì‘í•˜ëŠ” í‚¤" />
          <div class="small">
            ğŸ”’ ì¶”ì²œ: í‚¤ ì œí•œì—ì„œ <b>HTTP referrers</b>ë¥¼ <span class="mono" id="refHint"></span> ë¡œ ì œí•œí•˜ë©´
            ë‚¨ì´ í›”ì³ë„ ëª» ì”ë‹ˆë‹¤.
          </div>
        </div>

        <div>
          <label>2) ë‚´ ì±„ë„ ì…ë ¥ (@í•¸ë“¤ / ì±„ë„ URL / ì±„ë„ID)</label>
          <input id="channelInput" placeholder="ì˜ˆ: @yourhandle ë˜ëŠ” https://youtube.com/@yourhandle ë˜ëŠ” UCxxxx" />
        </div>

        <div>
          <label>3) ëª©í‘œ êµ¬ë…ì ìˆ˜</label>
          <input id="goalInput" type="number" min="1" placeholder="ì˜ˆ: 10000" />
        </div>

        <div>
          <label>í‘œì‹œ ì œëª©(ì˜µì…˜)</label>
          <input id="labelInput" placeholder="ì˜ˆ: êµ¬ë…ì ì§„í–‰ë¥ " />
        </div>

        <div>
          <label>ê°±ì‹  ì£¼ê¸°(ì´ˆ)</label>
          <input id="refreshInput" type="number" min="10" placeholder="ê¸°ë³¸ 60" />
        </div>

        <button id="saveBtn">ì €ì¥í•˜ê³  ìœ„ì ¯ ë³´ê¸°</button>
        <button id="makeEmbedBtn" class="ghost">ë…¸ì…˜ ì„ë² ë“œ ë§í¬ ë§Œë“¤ê¸°</button>

        <div class="hr"></div>

        <div>
          <label>ì„ë² ë“œ ë§í¬ (ë…¸ì…˜ /embedì— ë¶™ì—¬ë„£ê¸°)</label>
          <input id="embedLink" class="mono" readonly />
          <button id="copyBtn" style="display:none">ë§í¬ ë³µì‚¬</button>
        </div>

        <div class="err" id="fatal"></div>
        <div class="small">â€» í‚¤ëŠ” URLì— í¬í•¨ë˜ì§€ ì•Šê³ , ì´ ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë©ë‹ˆë‹¤.</div>
      </div>
    </div>

    <div id="widget">
      <div class="wrap">
        <div class="ring">
          <svg viewBox="0 0 100 100" aria-hidden="true">
            <circle cx="50" cy="50" r="42" fill="none" stroke="rgba(0,0,0,0.08)" stroke-width="16" />
            <circle id="prog" cx="50" cy="50" r="42"
              fill="none" stroke="rgba(0,0,0,0.75)" stroke-width="16" stroke-linecap="round"
              transform="rotate(-90 50 50)"
              stroke-dasharray="263.89" stroke-dashoffset="263.89" />
          </svg>

          <div class="center">
            <div>
              <div class="count" id="count">â€”</div>
              <div class="sub" id="sub">ëª©í‘œ â€”</div>
              <div class="pct" id="pct">â€”%</div>
              <div class="err" id="err"></div>
              <div style="margin-top:10px;">
                <button id="settingsBtn" class="ghost" style="font-size:12px; padding:8px 10px;">ì„¤ì •</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

<script>
  // âœ… ì—ëŸ¬ê°€ ë‚˜ë©´ í™”ë©´ì— í‘œì‹œ(ì´ˆë³´ììš©)
  window.addEventListener("error", (e) => {
    const el = document.getElementById("fatal");
    if (el) el.textContent = "ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜: " + (e?.message || e);
  });

  const qs = new URLSearchParams(location.search);
  const LS_KEY = "ytWidget.userApiKey";

  function parseChannel(inputRaw) {
    if (!inputRaw) return { channelId: null, handle: null };
    const input = inputRaw.trim();
    if (input.startsWith("UC") && input.length >= 10) return { channelId: input, handle: null };
    if (input.startsWith("@")) return { channelId: null, handle: input };
    try {
      if (input.includes("youtube.com")) {
        const u = new URL(input);
        const m1 = u.pathname.match(/\/channel\/(UC[\w-]+)/);
        if (m1) return { channelId: m1[1], handle: null };
        const m2 = u.pathname.match(/\/@([\w.\-]+)/);
        if (m2) return { channelId: null, handle: "@" + m2[1] };
      }
    } catch (_) {}
    return { channelId: null, handle: "@" + input.replace(/^@/, "") };
  }
  const format = (n) => (n == null) ? "â€”" : Number(n).toLocaleString("ko-KR");

  // title/ref hint
  document.getElementById("title").textContent = qs.get("label") || "YouTube êµ¬ë…ì";
  document.getElementById("refHint").textContent = `${location.origin}/*`;

  const savedKey = localStorage.getItem(LS_KEY) || "";

  // inputs default
  const apiKeyInput = document.getElementById("apiKeyInput");
  const channelInput = document.getElementById("channelInput");
  const goalInput = document.getElementById("goalInput");
  const labelInput = document.getElementById("labelInput");
  const refreshInput = document.getElementById("refreshInput");
  const embedLink = document.getElementById("embedLink");
  const copyBtn = document.getElementById("copyBtn");

  apiKeyInput.value = savedKey;
  channelInput.value = qs.get("channel") || "";
  goalInput.value = qs.get("goal") || "";
  labelInput.value = qs.get("label") || "";
  refreshInput.value = qs.get("refresh") || "";

  function buildEmbedUrl() {
    const ch = channelInput.value.trim();
    const g = Number(goalInput.value || 0);
    const l = labelInput.value.trim();
    const r = Number(refreshInput.value || 60);
    const k = apiKeyInput.value.trim();
    if (!k) throw new Error("API Keyë¥¼ ì…ë ¥í•´ì¤˜!");
    if (!ch) throw new Error("ì±„ë„ì„ ì…ë ¥í•´ì¤˜!");
    if (!g || g <= 0) throw new Error("ëª©í‘œ êµ¬ë…ì ìˆ˜ë¥¼ ì…ë ¥í•´ì¤˜!");

    const url = new URL(location.origin + location.pathname);
    url.searchParams.set("channel", ch);
    url.searchParams.set("goal", String(g));
    if (l) url.searchParams.set("label", l);
    if (r && r !== 60) url.searchParams.set("refresh", String(r));
    return url.toString();
  }

  document.getElementById("saveBtn").onclick = () => {
    const k = apiKeyInput.value.trim();
    if (!k) return alert("API Keyë¥¼ ì…ë ¥í•´ì¤˜!");
    localStorage.setItem(LS_KEY, k);
    try { location.href = buildEmbedUrl(); }
    catch (e) { alert(e.message || String(e)); }
  };

  document.getElementById("makeEmbedBtn").onclick = () => {
    try {
      embedLink.value = buildEmbedUrl();
      copyBtn.style.display = "block";
    } catch (e) { alert(e.message || String(e)); }
  };

  copyBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(embedLink.value);
      copyBtn.textContent = "ë³µì‚¬ë¨!";
      setTimeout(() => (copyBtn.textContent = "ë§í¬ ë³µì‚¬"), 1200);
    } catch (e) { alert("ë³µì‚¬ ì‹¤íŒ¨: ë¸Œë¼ìš°ì € ê¶Œí•œì„ í™•ì¸í•´ì¤˜"); }
  };

  // ìœ„ì ¯ ëª¨ë“œ ì§„ì… ì¡°ê±´
  const goal = Number(qs.get("goal") || 0);
  const refreshSec = Number(qs.get("refresh") || 60);
  const parsed = parseChannel(qs.get("channel") || "");
  const channelId = qs.get("channelId") || parsed.channelId;
  const handle = qs.get("handle") || parsed.handle;
  const hasTarget = !!(channelId || handle) && goal > 0;
  const hasKey = !!(localStorage.getItem(LS_KEY) || "");

  const configEl = document.getElementById("config");
  const widgetEl = document.getElementById("widget");

  if (!hasTarget || !hasKey) {
    // ì„¤ì • í™”ë©´ ìœ ì§€
    configEl.style.display = "block";
    widgetEl.style.display = "none";
  } else {
    // ìœ„ì ¯ í™”ë©´
    configEl.style.display = "none";
    widgetEl.style.display = "block";

    document.getElementById("settingsBtn").onclick = () => {
      location.href = location.origin + location.pathname;
    };

    const apiKey = localStorage.getItem(LS_KEY);

    const CIRC = 2 * Math.PI * 42;
    const prog = document.getElementById("prog");
    prog.setAttribute("stroke-dasharray", CIRC.toFixed(2));

    function setProgress(p) {
      const clamped = Math.max(0, Math.min(1, p));
      const offset = CIRC * (1 - clamped);
      prog.setAttribute("stroke-dashoffset", offset.toFixed(2));
    }

    async function fetchSubscriberCount() {
      const base = new URL("https://www.googleapis.com/youtube/v3/channels");
      base.searchParams.set("part", "statistics");
      if (channelId) base.searchParams.set("id", channelId);
      else base.searchParams.set("forHandle", handle);
      base.searchParams.set("key", apiKey);
      const r = await fetch(base.toString());
      const data = await r.json();
      if (!r.ok) throw new Error(data?.error?.message || "YouTube API error");
      const item = data.items?.[0];
      const stats = item?.statistics;
      return stats?.subscriberCount != null ? Number(stats.subscriberCount) : null;
    }

    async function tick() {
      const errEl = document.getElementById("err");
      errEl.textContent = "";
      try {
        const subs = await fetchSubscriberCount();
        document.getElementById("count").textContent = format(subs);
        document.getElementById("sub").textContent = `ëª©í‘œ ${format(goal)}`;
        if (subs == null) {
          errEl.textContent = "êµ¬ë…ì ìˆ˜ê°€ ìˆ¨ê¹€ ì²˜ë¦¬ëœ ì±„ë„ì¼ ìˆ˜ ìˆì–´ìš”.";
          setProgress(0);
          document.getElementById("pct").textContent = "â€”%";
          return;
        }
        const p = subs / goal;
        setProgress(p);
        document.getElementById("pct").textContent = (p * 100).toFixed(1) + "%";
      } catch (e) {
        errEl.textContent = "ì˜¤ë¥˜: " + (e?.message || String(e));
      }
    }

    tick();
    setInterval(tick, Math.max(10, refreshSec) * 1000);
  }
</script>
</body>
</html>
